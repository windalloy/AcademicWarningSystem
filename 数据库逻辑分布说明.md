# 数据库逻辑分布说明

## 概述

本项目的数据库逻辑主要分布在 **SQL文件** 和 **Python代码** 中。核心业务逻辑主要在SQL文件中，Python代码主要负责数据访问和界面交互。

---

## 一、SQL文件中的数据库逻辑（核心）

**文件位置**：`AcademicWarningSystem.sql`

### 1. 数据表结构（DDL）
- **Student（学生表）**：学号、姓名、院系、入学年份
- **Course（课程表）**：课程号、课程名、学分、课程类型
- **Score（成绩表）**：学号、课程号、成绩、学期
- **GraduationRequirement（毕业要求表）**：院系、总学分要求、核心课不及格上限、最低GPA
- **CoreCourse（核心课程表）**：院系与核心课程的关联

**特点**：严格遵循三大范式，无冗余字段

### 2. 计算函数（Function）
- **`fn_CalculateGPA(score)`**：根据成绩计算绩点
  - 90-100分 → 4.0
  - 80-89分 → 3.0
  - 70-79分 → 2.0
  - 60-69分 → 1.0
  - <60分 → 0.0

- **`fn_IsPassed(score)`**：判断是否通过（≥60为通过）

### 3. 视图（View）
- **`StudentGPAView`**：计算每位学生的平均绩点和已获学分
  - 通过 `fn_CalculateGPA()` 函数计算绩点
  - 通过聚合函数计算总学分和加权平均GPA

- **`FailedCoreCoursesView`**：列出核心课程不及格记录
  - 使用 `fn_IsPassed()` 函数判断是否通过

- **`CreditsCompletedView`**：统计每位学生已获学分总数
  - 仅统计已通过的课程（使用 `fn_IsPassed()`）

- **`FailedCoursesView`**：列出所有未通过课程（不仅仅是核心课程）

### 4. 存储过程（Stored Procedure）
- **`usp_GenerateWarningList()`**：自动生成预警学生名单
  - **预警条件1**：已获学分 < 毕业要求总学分的80%
  - **预警条件2**：核心课程不及格数量 ≥ 毕业要求中设定的上限
  - 使用子查询和函数动态计算，无冗余数据

### 5. 触发器（Trigger）
- **`trg_AfterInsert_Score_Validate`**：插入成绩后验证数据
- **`trg_AfterUpdate_Score_Validate`**：更新成绩后验证数据
- 注意：由于严格遵循三大范式，不更新冗余字段，主要用于数据验证

### 6. 复杂查询示例
SQL文件中包含7个复杂查询示例：
1. 查询某学生所有不及格课程
2. 统计各院系平均GPA
3. 查询核心课程挂科≥2门的学生
4. 查询学分不足毕业要求80%的学生
5. 查询每学期学生选课数量统计
6. 查询所有学生的详细成绩单
7. 执行预警存储过程

---

## 二、Python代码中的数据库逻辑（辅助）

**文件位置**：`database/db_manager.py`

### 1. 数据库连接管理
- 连接配置
- 连接/断开方法
- SQL文件执行

### 2. 数据访问方法（CRUD）
- **学生管理**：`get_all_students()`, `add_student()`, `update_student()`, `delete_student()`
- **课程管理**：`get_all_courses()`, `add_course()`, `update_course()`, `delete_course()`
- **成绩管理**：`get_all_scores()`, `add_score()`, `update_score()`, `delete_score()`
- **毕业要求管理**：`get_graduation_requirements()`, `add_graduation_requirement()`, 等
- **核心课程管理**：`get_core_courses()`, `add_core_course()`, `delete_core_course()`

### 3. 查询方法
- **`get_warning_list()`**：调用存储过程 `usp_GenerateWarningList()`
- **`get_failed_core_courses()`**：查询核心课程不及格（使用视图）
- **`get_failed_courses()`**：查询所有未通过课程（使用视图）
- **`get_student_gpa_view()`**：获取学生GPA视图
- **`get_credits_completed()`**：获取学分完成情况（使用视图）
- **`get_department_statistics()`**：获取各院系统计
- **`get_semester_statistics()`**：获取学期统计

### 4. 辅助方法
- **`calculate_gpa(score_value)`**：Python端计算绩点（与数据库函数逻辑一致，用于界面显示）

---

## 三、数据库逻辑分布总结

### 核心业务逻辑（在SQL文件中）
✅ **表结构设计**：5张表，严格遵循三大范式  
✅ **计算逻辑**：GPA计算、是否通过判断（函数）  
✅ **数据聚合**：学分统计、GPA计算（视图）  
✅ **预警逻辑**：预警条件判断（存储过程）  
✅ **数据验证**：触发器验证  
✅ **复杂查询**：7个查询示例

### 数据访问层（在Python代码中）
✅ **连接管理**：数据库连接、断开  
✅ **CRUD操作**：增删改查的SQL语句封装  
✅ **存储过程调用**：调用数据库存储过程  
✅ **视图查询**：查询数据库视图  
✅ **辅助计算**：Python端辅助计算（与数据库函数一致）

---

## 四、写报告时的建议

### 重点说明SQL文件中的逻辑

1. **数据库设计**
   - 5张表的结构和关系
   - 三大范式的应用
   - 外键约束和索引设计

2. **函数设计**
   - `fn_CalculateGPA()` 和 `fn_IsPassed()` 的设计思路
   - 为什么使用函数而不是存储冗余字段

3. **视图设计**
   - 4个视图的作用和实现
   - 如何通过视图实现数据计算和聚合

4. **存储过程设计**
   - `usp_GenerateWarningList()` 的预警逻辑
   - 如何实现自动筛选预警学生

5. **触发器设计**
   - 触发器的用途（数据验证）

6. **复杂查询**
   - 7个查询示例展示SQL的复杂应用

### Python代码部分

可以简要说明：
- Python代码主要负责数据访问和界面交互
- 业务逻辑主要在数据库端实现
- 体现了"数据库为中心"的设计思想

---

## 五、关键代码位置

### SQL文件
- **表结构**：第34-92行
- **函数**：第96-122行
- **视图**：第128-195行
- **触发器**：第208-230行
- **存储过程**：第242-300行
- **复杂查询**：第350-484行

### Python代码
- **数据库管理**：`database/db_manager.py`
- **界面逻辑**：`gui/` 目录下的各个文件

---

## 总结

**数据库逻辑主要在SQL文件中**，包括：
- ✅ 表结构设计
- ✅ 计算函数
- ✅ 视图（数据聚合和计算）
- ✅ 存储过程（预警逻辑）
- ✅ 触发器（数据验证）
- ✅ 复杂查询示例

**Python代码主要负责**：
- 数据访问封装
- 界面交互
- 调用数据库对象（视图、存储过程、函数）

这种设计体现了**数据库为中心**的架构思想，将业务逻辑放在数据库端，保证了数据一致性和性能。

